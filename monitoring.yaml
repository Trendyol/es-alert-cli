- name: 'ProductOfferingPDP Product Detail API Monitor'
  type: "monitor"
  enabled: true
  schedule:
    period:
      interval: 5
      unit: MINUTES
    cron: null
  inputs:
    - search:
        indices:
          - 'pdp-log-*'
        query:
          query:
            bool:
              adjust_pure_negative: true
              boost: 1
              must:
                - match:
                    x.level:
                      auto_generate_synonyms_phrase_query: true
                      boost: 1
                      fuzzy_transpositions: true
                      lenient: false
                      max_expansions: 50
                      operator: AND
                      prefix_length: 0
                      query: ERROR
                      zero_terms_query: NONE
                - match:
                    kubernetes.labels.release:
                      auto_generate_synonyms_phrase_query: true
                      boost: 1
                      fuzzy_transpositions: true
                      lenient: false
                      max_expansions: 50
                      operator: AND
                      prefix_length: 0
                      query: "product-detail-api"
                      zero_terms_query: NONE
                - range:
                    '@timestamp':
                      boost: 1
                      from: now-5m
                      include_lower: true
                      include_upper: false
                      time_zone: "+03:00"
                      to: now
              must_not:
                - match:
                    x.message:
                      auto_generate_synonyms_phrase_query: true
                      boost: 1
                      fuzzy_transpositions: true
                      lenient: false
                      max_expansions: 50
                      operator: AND
                      prefix_length: 0
                      query: Generic Exception Occurred. org.springframework.web.HttpRequestMethodNotSupportedException
                      zero_terms_query: NONE
  ##EXCLUDE##
  triggers:
    - name: "ProductOfferingPDP Product Detail API Error Alert"
      severity: "1"
      condition:
        script:
          source: ctx.results[0].hits.total.value > 300
          lang: painless
      actions:
        - name: "ProductOfferingPDP Product Detail API Error Alert"
          destinationId: product-offering-pdp-oncall
          subject:
            source: "ProductOfferingPDP Product Detail API Error Alert"
            lang: mustache
          message:
            source: |-
              {
                "title":"{{ctx.monitor.name}} just entered alert status. -New-Comment- Please investigate the issue.",
                "monitor":{
                    "name":"{{ctx.monitor.name}}",
                    "enabled":"{{ctx.monitor.enabled}}"
                },
                "trigger":{
                    "id":"{{ctx.trigger.id}}",
                    "name":"{{ctx.trigger.name}} \n> *Cluster-based Logs:* *<https://kibana-discovery-logging-01.stage.trendyol.com/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-20m,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:a0980db0-49f8-11ed-8c51-6f32aac10425,key:kubernetes.labels.release.keyword,negate:!f,params:(query:product-detail-api),type:phrase),query:(match_phrase:(kubernetes.labels.release.keyword:product-detail-api))),('$state':(store:appState),meta:(alias:!n,disabled:!f,index:a0980db0-49f8-11ed-8c51-6f32aac10425,key:x.level,negate:!f,params:(query:x.level),type:phrase),query:(match_phrase:(x.level:ERROR)))),index:a0980db0-49f8-11ed-8c51-6f32aac10425,interval:auto,query:(language:kuery,query:''),sort:!(!('@timestamp',desc)))|stage >* \n> *Sample Message:* {{ctx.results.0.hits.hits.0._source.x.message}}\n> *Agent Name:* {{ctx.results.0.hits.hits.0._source.x.agent-name}}\n> *Cluster:* {{ctx.results.0.hits.hits.0._source.x_cluster}}\n> *Severity:* {{ctx.results.0.hits.hits.0._source.x.level}}\n> *Count:* {{ctx.results.0.hits.total.value}}",
                    "severity":"1"
                },
                "periodStart":"{{ctx.periodStart}}",
                "periodEnd":"{{ctx.periodEnd}}"
              }
            lang: mustache
